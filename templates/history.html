{% extends 'base.html' %}
{% load static %}

{% block title %}Expenses - History{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
{% endblock %}

{% block content %}
<div class="flex justify-center items-center m-5">
    <div class="max-w-sm w-full bg-neutral-primary-soft border border-default rounded-base shadow-xs p-4 md:p-6">
        <div class="flex justify-between items-start w-full">
            <div class="flex-col items-center">
                <div id="dateRangeDropdown"
                    class="z-10 hidden bg-neutral-primary-soft rounded-base shadow-xs border border-default w-80 lg:w-112">
                    <div id="date-range-picker" date-rangepicker class="flex items-center p-2">
                        <div class="relative">
                            <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
                                <svg class="w-4 h-4 text-body" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                                    width="24" height="24" fill="none" viewBox="0 0 24 24">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M4 10h16m-8-3V4M7 7V4m10 3V4M5 20h14a1 1 0 0 0 1-1V7a1 1 0 0 0-1-1H5a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1Zm3-7h.01v.01H8V13Zm4 0h.01v.01H12V13Zm4 0h.01v.01H16V13Zm-8 4h.01v.01H8V17Zm4 0h.01v.01H12V17Zm4 0h.01v.01H16V17Z" />
                                </svg>
                            </div>
                            <input id="datepicker-range-start" name="start" type="text"
                                class="block w-full ps-9 pe-3 py-2.5 bg-neutral-secondary-medium border border-default-medium text-heading text-sm rounded-base focus:ring-brand focus:border-brand px-3 py-2.5 shadow-xs placeholder:text-body"
                                placeholder="Start date">
                        </div>
                        <span class="mx-4 text-body">to</span>
                        <div class="relative">
                            <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
                                <svg class="w-4 h-4 text-body" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                                    width="24" height="24" fill="none" viewBox="0 0 24 24">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M4 10h16m-8-3V4M7 7V4m10 3V4M5 20h14a1 1 0 0 0 1-1V7a1 1 0 0 0-1-1H5a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1Zm3-7h.01v.01H8V13Zm4 0h.01v.01H12V13Zm4 0h.01v.01H16V13Zm-8 4h.01v.01H8V17Zm4 0h.01v.01H12V17Zm4 0h.01v.01H16V17Z" />
                                </svg>
                            </div>
                            <input id="datepicker-range-end" name="end" type="text"
                                class="block w-full ps-9 pe-3 py-2.5 bg-neutral-secondary-medium border border-default-medium text-heading text-sm rounded-base focus:ring-brand focus:border-brand px-3 py-2.5 shadow-xs placeholder:text-body"
                                placeholder="End date">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Line Chart -->
        <div class="py-6 mb-5" id="pie-chart"></div>
    </div>
</div>

<div class="relative overflow-x-auto bg-neutral-primary-soft shadow-xs rounded-base border border-default m-5">
    <table class="w-full text-sm text-left rtl:text-right text-body">
        <thead class="text-sm text-body bg-neutral-secondary-medium border-b border-default-medium">
            <tr>
                <th scope="col" class="px-6 py-3 font-medium">Description</th>
                <th scope="col" class="px-6 py-3 font-medium">Date</th>
                <th scope="col" class="px-6 py-3 font-medium">Amount</th>
            </tr>
        </thead>
        <tbody>
            {% for expense in expenses %}
            <tr class="bg-neutral-primary-soft border-b border-default hover:bg-neutral-secondary-medium">
                <th scope="row" class="px-6 py-4 font-medium text-heading whitespace-nowrap">{{ expense.description }}
                </th>
                <td class="px-6 py-4">{{ expense.date|date:"d-m-Y" }}</td>
                <td class="px-6 py-4">{{ expense.amount }} EGP</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="h-16"></div>
{% endblock %}

{% block extra_js %}
<script>
    const getChartOptions = () => {
        // Initialize aggregation object
        const categoryData = {};

        // Loop through the records passed from Django
        {% for expense in expenses %}
        var category = "{{ expense.category|escapejs }}";
        var amount = parseFloat("{{ expense.amount }}") || 0;

        if (categoryData[category]) {
            categoryData[category] += amount;
        } else {
            categoryData[category] = amount;
        }
        {% endfor %}

        const labels = Object.keys(categoryData);
        const series = Object.values(categoryData);

        // Fallback for empty data
        const hasData = series.length > 0 && series.reduce((a, b) => a + b, 0) > 0;

        return {
            series: hasData ? series : [1],
            labels: hasData ? labels : ["No Data"],
            colors: ["#2563eb", "#3b82f6", "#1e40af", "#9333ea", "#f59e0b", "#10b981", "#ef4444"],
            chart: {
                height: 420,
                width: "100%",
                type: "pie",
            },
            stroke: {
                colors: ["white"],
                lineCap: "",
            },
            plotOptions: {
                pie: {
                    labels: {
                        show: true,
                    },
                    size: "100%",
                    dataLabels: {
                        offset: -25
                    }
                },
            },
            dataLabels: {
                enabled: hasData,
                style: {
                    fontFamily: "Inter, sans-serif",
                },
            },
            legend: {
                position: "bottom",
                fontFamily: "Inter, sans-serif",
            },
            tooltip: {
                enabled: hasData,
                y: {
                    formatter: function (value) {
                        return value + " EGP"
                    }
                }
            },
            yaxis: {
                labels: {
                    formatter: function (value) {
                        return value + " EGP"
                    },
                },
            },
            xaxis: {
                labels: {
                    formatter: function (value) {
                        return value + " EGP"
                    },
                },
                axisTicks: {
                    show: false,
                },
                axisBorder: {
                    show: false,
                },
            },
        }
    }

    if (document.getElementById("pie-chart") && typeof ApexCharts !== 'undefined') {
        const chart = new ApexCharts(document.getElementById("pie-chart"), getChartOptions());
        chart.render();
    }
</script>
{% endblock %}